// Jenkinsfile

try {

  stage('checkout') {
      node {
        cleanWs()
        checkout scm
      }
  }
  stage('init') {
    node {  
      withCredentials([
        azureServicePrincipal('azserviceprincipal')]) {
          ansiColor('xterm') {
          sh 'terraform init'
          }     
        }
    }  
  }    
  stage('create workspace') {
    node {  
      withCredentials([
        azureServicePrincipal('azserviceprincipal')]) {
          ansiColor('xterm') {
          sh 'terraform workspace new "production"'
          }     
        }
    }  
  }  
  stage('plan') {
    node {  
      withCredentials([
        azureServicePrincipal('azserviceprincipal')]) {
          ansiColor('xterm') {
          sh 'terraform plan -var-file="./terraform.tfstate.d/production/prod.tfvars" -out ./terraform.tfstate.d/production/prod.tfplan'
          }     
        }
    }  
  }
  stage('apply') {
    node {  
      withCredentials([
        azureServicePrincipal('azserviceprincipal')]) {
          ansiColor('xterm') {
          sh 'terraform apply -var-file="./terraform.tfstate.d/production/prod.tfvars"'
          }     
        }
    }  
  }
  stage('show') {
    node {  
      withCredentials([
        azureServicePrincipal('azserviceprincipal')]) {
          ansiColor('xterm') {
          sh 'terraform show'
          }     
        }
    }  
  }
}
catch (org.jenkinsci.plugins.workflow.steps.FlowInterruptedException flowError) {
  currentBuild.result = 'ABORTED'
}
catch (err) {
  currentBuild.result = 'FAILURE'
  throw err
}
finally {
  if (currentBuild.result == 'SUCCESS') {
    currentBuild.result = 'SUCCESS'
  }
}
